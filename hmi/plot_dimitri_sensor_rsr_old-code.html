<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:41 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>plot_dimitri_sensor_rsr_old.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="plot_dimitri_sensor_rsr_old.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      PLOT_DIMITRI_SENSOR_RSR       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      THIS FILE CONTAINS AND NUMBER OF ROUTINES WHICH CREATE AN INTERACTIVE OBJECT </span>
<span class="comments">;*      GRAPHICS WINDOW ALLOWING USERS TO OVERLPLOT THE SPECTRAL RESPONSE FOR ANY SELECTED </span>
<span class="comments">;*      DIMITRI SENSOR, ADD/REMOVE A LEGEND, AND IMPORT A USER CREATED RSR FILE (NOTE, </span>
<span class="comments">;*      MUST BE A SEMI-COLON SEPERATED FILE WITH THE COLUMNS "WAVELENGTH" AND </span>
<span class="comments">;*      "SPECTRAL RESPONSE", WITH DATA STARTING ON LINE 1 (STARTING FROM 0)</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      PLOT_DIMITRI_SENSOR_RSR,RANGE     </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      RANGE    - A 2-ELEMENT INTEGER ARRAY CONTAINING THE MIN AND MAX WAVELENGTHS OF INTEREST</span>
<span class="comments">;*                 E.G. [400,1000]</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE  - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      28 JAN 2011 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      21 FEB 2011 - C KENT   - ADDED CATCH FOR WIDGET RESIZE, UPDATE EGEND TO UPDATE IF ON</span>
<span class="comments">;*      21 MAR 2011 - C KENT   - MODIFIED FILE DEFINITION TO USE GET_DIMITRI_LOCATION</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      23 DEC 2010 - C KENT   - </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

PRO RSR_OBJECT_EVENT, EVENT

  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE = RSR_INFO     , /NO_COPY
  WIDGET_CONTROL, EVENT.ID,   GET_UVALUE = ACTION
  RSR_INFO.RSR_WINDOW->DRAW, RSR_INFO.RSR_VIEW 
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE = RSR_INFO,/NO_COPY

END

<span class="comments">;--------------------------------------------------------------------</span>
<span class="comments">;()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()</span>
<span class="comments">;--------------------------------------------------------------------</span>


PRO RSR_OBJECT_EXIT, EVENT
  
<span class="comments">;------------------------------------</span>
<span class="comments">; CLEANUP POINTERS AND OBJECTS FROM MEMORY  </span>
  
  WIDGET_CONTROL, EVENT.TOP, GET_UVALUE = RSR_INFO, /NO_COPY
  PTR_FREE,       RSR_INFO.USERXDATA
  PTR_FREE,       RSR_INFO.USERYDATA
  OBJ_DESTROY,    RSR_INFO.RSR_XTITLE
  OBJ_DESTROY,    RSR_INFO.RSR_YTITLE
  OBJ_DESTROY,    RSR_INFO.RSR_XAXIS
  OBJ_DESTROY,    RSR_INFO.RSR_YAXIS
  OBJ_DESTROY,    RSR_INFO.RSR_LEGEND
  OBJ_DESTROY,    RSR_INFO.RSR_LEGENDMODEL
  OBJ_DESTROY,    RSR_INFO.RSR_PALETTE
  OBJ_DESTROY,    RSR_INFO.RSR_VIEW
  OBJ_DESTROY,    RSR_INFO.RSR_WINDOW
  WIDGET_CONTROL, EVENT.TOP, /DESTROY

END

<span class="comments">;--------------------------------------------------------------------</span>
<span class="comments">;()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()</span>
<span class="comments">;--------------------------------------------------------------------</span>

PRO RSR_OBJECT_OPTION,EVENT,VERBOSE=VERBOSE

  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE = RSR_INFO     , /NO_COPY
  WIDGET_CONTROL, EVENT.ID,   GET_UVALUE = ACTION

  IF N_ELEMENTS(ACTION) EQ 0 THEN GOTO,NO_RSR

<span class="comments">;------------------------------------</span>
<span class="comments">; FIND OUT IF THE USER WANTS TO </span>
<span class="comments">; OVERLAY A SENSOR RSR</span>

  RES = WHERE(STRCMP(RSR_INFO.SENSOR_ID,ACTION) EQ 1)
  IF RES[0] GT -1 THEN BEGIN
    
<span class="comments">;------------------------------------</span>
<span class="comments">; IF THE SENSOR ISN'T ALREADY SHOWN </span>
<span class="comments">; THEN LOOP OVER EACH BAND AND PLOT THE DATA </span>
   
    IF RSR_INFO.SENS_ON[RES] LT 1 THEN BEGIN
      FOR RSR_SENS=0L,RSR_INFO.SENSOR_BANDS[RES[0]]-1 DO BEGIN
        RSR_INFO.RSR_OBJ[RSR_SENS,RES,0]  = OBJ_NEW('IDLGRPLOT',RSR_INFO.WAVELENGTHS,RSR_INFO.RSR_DATA[*,RSR_SENS,RES]  ,$
                                                    LINESTYLE=0, COLOR=RSR_INFO.SENSOR_COLOURS[*,RES],THICK=1       ,$
                                                    XCOORD_CONV = NORM_COORD(RSR_INFO.RSR_XRANGE)                   ,$
                                                    YCOORD_CONV = NORM_COORD(RSR_INFO.RSR_YRANGE)                    $
                                                    )
        RSR_INFO.RSR_OBJ[RSR_SENS,RES,1]  = OBJ_NEW('IDLGRMODEL')
        RSR_INFO.RSR_OBJ[RSR_SENS,RES,1]  ->ADD,  RSR_INFO.RSR_OBJ[RSR_SENS,RES,0]
        RSR_INFO.RSR_VIEW                 ->ADD,  RSR_INFO.RSR_OBJ[RSR_SENS,RES,1]
        RSR_INFO.SENS_ON[RES]             = 1
      ENDFOR
    ENDIF

<span class="comments">;------------------------------------  </span>
<span class="comments">; IF LEGEND IS ON THE UPDATE IT FOR ALL DATA ON </span>

    RSR_INFO.RSR_LEGEND->GETPROPERTY,HIDE=TEMP
    IF TEMP EQ 0 THEN BEGIN <span class="comments">;IF THE LEGEND IS ON THEN SWTICH IT OFF</span>
      RES = WHERE(RSR_INFO.SENS_ON EQ 1)
      IF RSR_INFO.USER_DATA_ON[0] EQ 1 THEN BEGIN
        TEMP = [RSR_INFO.USER_COLOUR,REFORM(RSR_INFO.SENSOR_COLOURS[*,RES],N_ELEMENTS(RSR_INFO.SENSOR_COLOURS[*,RES]))]
        TEMP = REFORM(TEMP,3,N_ELEMENTS(RES)+1)
        RSR_INFO.RSR_LEGEND->SETPROPERTY, ITEM_NAME  = [RSR_INFO.USER_DATA_NAME,RSR_INFO.SENSOR_ID[RES]],$ 
                                            ITEM_COLOR = TEMP                                             ,$
                                            THICK      = MAKE_ARRAY(N_ELEMENTS(RES)+1,VALUE=2)
      ENDIF ELSE BEGIN
        RSR_INFO.RSR_LEGEND->SETPROPERTY, ITEM_NAME  = RSR_INFO.SENSOR_ID[RES]                    ,$
                                            ITEM_COLOR = RSR_INFO.SENSOR_COLOURS[*,RES]             ,$
                                            THICK      = MAKE_ARRAY(N_ELEMENTS(RES),VALUE=2)

      ENDELSE
    ENDIF
  ENDIF 

<span class="comments">;------------------------------------</span>
<span class="comments">; IF THE RESET IS SELECTED THEN DELETE </span>
<span class="comments">; ALL PLOTS AND TURN THE LEGEND OFF</span>

  IF STRCMP(ACTION,'RESET') EQ 1 THEN BEGIN 
    NON_VALUES = FLTARR(N_ELEMENTS(RSR_INFO.WAVELENGTHS))
    RSR_INFO.RSR_LEGEND->GETPROPERTY,HIDE=TEMP
    IF TEMP EQ 0 THEN RSR_INFO.RSR_LEGEND->SETPROPERTY,HIDE=1
    FOR RSR_SENS=0,N_ELEMENTS(RSR_INFO.SENSOR_ID)-1 DO BEGIN
      IF RSR_INFO.SENS_ON[RSR_SENS] EQ 1 THEN BEGIN
        FOR J=0L,RSR_INFO.SENSOR_BANDS[RSR_SENS]-1 DO RSR_INFO.RSR_OBJ[J,RSR_SENS,0]->SETPROPERTY,DATAY=NON_VALUES
        RSR_INFO.SENS_ON[RSR_SENS] = 0
      ENDIF
    ENDFOR
    
<span class="comments">;------------------------------------    </span>
<span class="comments">; IF UESRR DATA IS CURRENTLY PLOTTED </span>
<span class="comments">; THEN REMOVE IT FROM THE WINDOW</span>
    
    IF RSR_INFO.USER_DATA_ON[0] EQ 1 THEN BEGIN
      RES         = WHERE(*RSR_INFO.USERXDATA GT RSR_INFO.RSR_XRANGE[0] AND *RSR_INFO.USERXDATA LT RSR_INFO.RSR_XRANGE[1])
      NON_VALUES  = FLTARR(N_ELEMENTS(RES))
      RSR_INFO.USR_DATA[0]      ->SETPROPERTY,DATAY=NON_VALUES
      RSR_INFO.USER_DATA_ON[0]  = 0
    ENDIF
  ENDIF

<span class="comments">;------------------------------------    </span>
<span class="comments">; IF THE LEGEND IS TO BE SWICTHED ON/OFF</span>

  IF STRCMP(ACTION,'LEGEND') EQ 1 THEN BEGIN <span class="comments">; MEANS LEGEND WHAT SELECTED</span>
    RSR_INFO.RSR_LEGEND->GETPROPERTY,HIDE=TEMP

<span class="comments">;------------------------------------    </span>
<span class="comments">; IF THE LEGEND ON SWITCH IT OFF </span>
<span class="comments">; AND EXIT</span>
    
    IF TEMP EQ 0 THEN BEGIN <span class="comments">;IF THE LEGEND IS ON THEN SWTICH IT OFF</span>
      RSR_INFO.RSR_LEGEND->SETPROPERTY,HIDE=1
      GOTO,LEGEND_SWITCH
    ENDIF

<span class="comments">;------------------------------------    </span>
<span class="comments">; IF THE LEGEND IS OFF THEN SWITCH IT ON </span>

    RES = WHERE(RSR_INFO.SENS_ON EQ 1) <span class="comments">;OF ANY SENSOR DATA IS PRESENT</span>
      IF RES[0] GT -1 THEN BEGIN

<span class="comments">;------------------------------------    </span>
<span class="comments">; ADD ANY USER IMPORTED AND SENSOR </span>
<span class="comments">; DATA TO THE LEGEND </span>

        IF RSR_INFO.USER_DATA_ON[0] EQ 1 THEN BEGIN
          TEMP = [RSR_INFO.USER_COLOUR,REFORM(RSR_INFO.SENSOR_COLOURS[*,RES],N_ELEMENTS(RSR_INFO.SENSOR_COLOURS[*,RES]))]
          TEMP = REFORM(TEMP,3,N_ELEMENTS(RES)+1)
          RSR_INFO.RSR_LEGEND->SETPROPERTY, ITEM_NAME  = [RSR_INFO.USER_DATA_NAME,RSR_INFO.SENSOR_ID[RES]],$ 
                                            ITEM_COLOR = TEMP                                             ,$
                                            THICK      = MAKE_ARRAY(N_ELEMENTS(RES)+1,VALUE=2)
        ENDIF ELSE BEGIN
          RSR_INFO.RSR_LEGEND->SETPROPERTY, ITEM_NAME  = RSR_INFO.SENSOR_ID[RES]                    ,$
                                            ITEM_COLOR = RSR_INFO.SENSOR_COLOURS[*,RES]             ,$
                                            THICK      = MAKE_ARRAY(N_ELEMENTS(RES),VALUE=2)

        ENDELSE

<span class="comments">;------------------------------------    </span>
<span class="comments">; TURN ON LEGEND IF ONLY THE USER </span>
<span class="comments">; DATA IS CURRENTLY PLOTTED </span>
     
      ENDIF ELSE IF RSR_INFO.USER_DATA_ON[0] EQ 1 THEN BEGIN 
        RSR_INFO.RSR_LEGEND->SETPROPERTY,  ITEM_NAME  = [RSR_INFO.USER_DATA_NAME]           ,$
                                           ITEM_COLOR = RSR_INFO.USER_COLOUR                ,$
                                           THICK      = [2] 
      ENDIF
    RSR_INFO.RSR_LEGEND->SETPROPERTY,HIDE=0
    LEGEND_SWITCH:
  ENDIF
  
  NO_RSR:
  RSR_INFO.RSR_WINDOW->DRAW, RSR_INFO.RSR_VIEW 
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE = RSR_INFO,/NO_COPY
END

<span class="comments">;--------------------------------------------------------------------</span>
<span class="comments">;()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()</span>
<span class="comments">;--------------------------------------------------------------------</span>

PRO RSR_OBJECT_IMPORT, EVENT

  WIDGET_CONTROL, EVENT.TOP, GET_UVALUE = RSR_INFO, /NO_COPY

<span class="comments">;------------------------------------ </span>
<span class="comments">; ONLY IMPORT IF THE USER HASN'T ALREADY</span>
  
  IF RSR_INFO.USER_DATA_ON[0] EQ 0 THEN BEGIN
    USR_RFILE = DIALOG_PICKFILE(TITLE='PLEASE SELECT A SPECTRAL RESPONSE FILE',/MUST_EXIST)
    IF USR_RFILE NE '' THEN BEGIN

<span class="comments">;------------------------------------ </span>
<span class="comments">; FILE SELECTION - NOTE, ASSUMES </span>
<span class="comments">; FILE IS IN RSR FILE TEMPLATE</span>

      TEMP = GET_DIMITRI_RSR_TEMPLATE()
      TEMP = READ_ASCII(USR_RFILE,TEMPLATE=TEMP)

<span class="comments">;------------------------------------ </span>
<span class="comments">; FIND WHERE THE DATA IS WITHIN THE </span>
<span class="comments">; USER SELECTED RANGE AND PLOT IT</span>

      RES = WHERE(TEMP.(0) GT RSR_INFO.RSR_XRANGE[0] AND TEMP.(0) LT RSR_INFO.RSR_XRANGE[1])
      IF RES[0] GT -1 THEN BEGIN
        *RSR_INFO.USERXDATA=TEMP.(0)[RES]
        *RSR_INFO.USERYDATA=TEMP.(1)[RES]
        RSR_INFO.USR_DATA[0]      = OBJ_NEW('IDLGRPLOT',*RSR_INFO.USERXDATA,*RSR_INFO.USERYDATA     ,$
                                        LINESTYLE = 0, COLOR = RSR_INFO.USER_COLOUR, THICK = 2      ,$
                                        XCOORD_CONV = NORM_COORD(RSR_INFO.RSR_XRANGE)               ,$
                                        YCOORD_CONV = NORM_COORD(RSR_INFO.RSR_YRANGE)                $
                                        )
        RSR_INFO.USR_DATA[1]      = OBJ_NEW('IDLGRMODEL')
        RSR_INFO.USR_DATA[1]->ADD ,RSR_INFO.USR_DATA[0]
        RSR_INFO.RSR_VIEW->ADD    ,RSR_INFO.USR_DATA[1]
        RSR_INFO.USER_DATA_ON[0]  = 1

<span class="comments">;------------------------------------ </span>
<span class="comments">; STORE THE FIRST SEVERN LETTERS </span>
<span class="comments">; OF THE INPUT FILE FOR THE LEGEND</span>

        TEMP  = STRSPLIT(USR_RFILE,'\',/EXTRACT)
 
        IF N_ELEMENTS(TEMP) EQ 1 THEN TEMP = STRSPLIT(USR_RFILE,'/',/EXTRACT)
        RES   = STRMID(TEMP[N_ELEMENTS(TEMP)-1],0,7)
        RSR_INFO.USER_DATA_NAME = RES
      ENDIF
    ENDIF
  ENDIF
  RSR_INFO.RSR_WINDOW->DRAW, RSR_INFO.RSR_VIEW
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE = RSR_INFO,/NO_COPY
END

<span class="comments">;--------------------------------------------------------------------</span>
<span class="comments">;()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()</span>
<span class="comments">;--------------------------------------------------------------------</span>

PRO RSR_OBJECT_EXPORT, EVENT
  
  WIDGET_CONTROL, EVENT.TOP,  GET_UVALUE = RSR_INFO, /NO_COPY
  WIDGET_CONTROL, EVENT.ID,   GET_UVALUE = ACTION
 
<span class="comments">;------------------------------------ </span>
<span class="comments">; STORE THE IMAGE WITHIN THE </span>
<span class="comments">; CURRENT RSR_WINDOW</span>

  RSR_INFO.RSR_WINDOW->GETPROPERTY, IMAGE_DATA = RSR_IMAGE   
  RSR_IMAGE2 = COLOR_QUAN(RSR_IMAGE,1,R,G,B)

<span class="comments">;------------------------------------ </span>
<span class="comments">; SAVE THE DATA AS REQUESTED</span>
  
  CASE ACTION OF
    'PNG':  BEGIN
              FILENAME = DIALOG_PICKFILE(/WRITE,FILE='RELATIVE_SPECTRAL_RESPONSE.PNG',/OVERWRITE_PROMPT)
              IF FILENAME NE '' THEN WRITE_PNG,FILENAME,RSR_IMAGE2,R,G,B
            END
    'JPG':  BEGIN
              FILENAME = DIALOG_PICKFILE(/WRITE,FILE='RELATIVE_SPECTRAL_RESPONSE.JPG',/OVERWRITE_PROMPT)
              IF FILENAME NE '' THEN WRITE_JPEG,FILENAME,RSR_IMAGE,TRUE=1
            END
    'CSV':  BEGIN
              FILENAME = DIALOG_PICKFILE(/WRITE,FILE='RELATIVE_SPECTRAL_RESPONSE.CSV',/OVERWRITE_PROMPT)
              IF FILENAME NE '' THEN BEGIN

<span class="comments">;------------------------------------ </span>
<span class="comments">; OPEN THE CSV FILE</span>
 
                OPENW,OUTF,FILENAME,/GET_LUN
                TEMP = N_ELEMENTS(RSR_INFO.WAVELENGTHS)
                PRINTF,OUTF,'SENSOR','BAND_INDEX',STRTRIM(STRING(RSR_INFO.WAVELENGTHS),2),$
                       FORMAT = STRING('('+STRTRIM(STRING(TEMP+1),2)+'(A,1H;),1(A))')

<span class="comments">;------------------------------------ </span>
<span class="comments">; IF USER DATA IMPORTED THEN RE-GRID </span>
<span class="comments">; IT TO THE USER REQUESTED WAVELENGTH </span>
<span class="comments">; RANGE AND PRINT TO FILE</span>

                IF RSR_INFO.USER_DATA_ON[0] EQ 1 THEN BEGIN
                  TEMPD = MAKE_ARRAY(/FLOAT,N_ELEMENTS(RSR_INFO.WAVELENGTHS))
                  NXDATA = *RSR_INFO.USERXDATA
                  NYDATA = *RSR_INFO.USERYDATA

                  FOR I=0,N_ELEMENTS(RSR_INFO.WAVELENGTHS)-1 DO BEGIN
                    TWL = RSR_INFO.WAVELENGTHS[I]
                    TMIN = MIN(ABS(NXDATA-TWL))
                    IF TMIN LT 1.01 THEN BEGIN
                      RES2 = WHERE(ABS(NXDATA-TWL) EQ TMIN)
                      TEMPD[I] = NYDATA[RES2[0]]
                    ENDIF
                  ENDFOR
                  PRINTF,OUTF,RSR_INFO.USER_DATA_NAME,0,TEMPD,$ 
                         FORMAT = STRING('(1(A,1H;),1(I,1H;),'+STRTRIM(STRING(TEMP-1),2)+'(F15.6,1H;),1(F15.6))')
                ENDIF

<span class="comments">;------------------------------------ </span>
<span class="comments">; PRINT OUT DATA FOR ANY SENSORS </span>
<span class="comments">; CURRENTLY PLOTTED</span>
  
                RES = WHERE(RSR_INFO.SENS_ON EQ 1)
                IF RES[0] GT -1 THEN BEGIN
                  FOR II=0,N_ELEMENTS(RES)-1 DO BEGIN
                    FOR JJ = 0,RSR_INFO.SENSOR_BANDS[RES[II]]-1 DO BEGIN
                      PRINTF,OUTF,RSR_INFO.SENSOR_ID[RES[II]],STRTRIM(STRING(JJ),2),RSR_INFO.RSR_DATA[*,JJ,RES[II]],$
                             FORMAT = STRING('(1(A,1H;),1(I,1H;),'+STRTRIM(STRING(TEMP-1),2)+'(F15.6,1H;),1(F15.6))')
                    ENDFOR
                  ENDFOR
                ENDIF
                FREE_LUN,OUTF
              ENDIF 
            END 
  ENDCASE
  
  RSR_INFO.RSR_WINDOW->DRAW,RSR_INFO.RSR_VIEW
  WIDGET_CONTROL, EVENT.TOP, SET_UVALUE=RSR_INFO,/NO_COPY  

END

<span class="comments">;--------------------------------------------------------------------</span>
<span class="comments">;()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()</span>
<span class="comments">;--------------------------------------------------------------------</span>

PRO PLOT_DIMITRI_SENSOR_RSR,RANGE,VERBOSE=VERBOSE,GROUP_LEADER=GROUP_LEADER

<span class="comments">;------------------------------------</span>
<span class="comments">; FIND LOCATION OF MAIN DIMITRI FOLDER</span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: RETRIEVEING DATA'
  <span class="comments">;CD, CURRENT = RSR_CDIR</span>
  <span class="comments">;RES = STRPOS(RSR_CDIR,'DIMITRI_',/REVERSE_SEARCH)</span>
  <span class="comments">;IF RES EQ -1 THEN BEGIN</span>
  <span class="comments">;  PRINT, 'RSR PLOT MODULE: ERROR ENCOUNTERED WHEN DETERMING MAIN DIMITRI FOLDER'</span>
  <span class="comments">;  RETURN</span>
  <span class="comments">;ENDIF</span>
  <span class="comments">;DL        = STRMID(RSR_CDIR,RES-1,1)</span>
  <span class="comments">;MAIN_DIRC = STRMID(RSR_CDIR,0,RES+11)+DL</span>
  <span class="comments">;SR_FOLDER = STRING(MAIN_DIRC+'AUX_DATA'+DL+'spectral_response'+DL)</span>
  
  DL = GET_DIMITRI_LOCATION('DL')
  SR_FOLDER = GET_DIMITRI_LOCATION('RSR')
  SBI_FILE = GET_DIMITRI_LOCATION('SENSOR_DATA')
  
   
<span class="comments">;------------------------------------</span>
<span class="comments">; DEFINE SENSOR DATA FILE</span>
  
  <span class="comments">;SBI_FILE = STRING(MAIN_DIRC+'Bin'+DL+'DIMITRI_SENSOR_DATA.txt')</span>
  RES = FILE_INFO(SBI_FILE)
  IF RES.EXISTS EQ 0 THEN BEGIN
    PRINT, 'RSR PLOT MODULE: ERROR, SENSOR INFORMATION FILE NOT FOUND'
    RETURN
  ENDIF

<span class="comments">;------------------------------------</span>
<span class="comments">; GET A LIST OF ALL SENSORS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: RETRIEVEING LIST OF SENSORS'
  TEMP        = GET_DIMITRI_SENSOR_DATA_TEMPLATE()
  RES         = READ_ASCII(SBI_FILE,TEMPLATE=TEMP)
  SENSOR_ID   = RES.SENSOR_ID
  NUM_SENSORS = N_ELEMENTS(SENSOR_ID)
  SENSOR_BANDS= RES.NUM_BANDS

<span class="comments">;------------------------------------</span>
<span class="comments">; DEFINE AN ARRAY CORREPOSNDING TO </span>
<span class="comments">; WL RANGE IN 0.5NM STEPS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: DEFINING WAVELENGTH RANGE'
  WL_RANGE    = FLOAT(RANGE)
  N_WL        = (WL_RANGE[1]-WL_RANGE[0])/0.5
  WAVELENGTHS = 0.5*FINDGEN(N_WL)+WL_RANGE[0]

<span class="comments">;------------------------------------</span>
<span class="comments">; CREATE ARRAYS TO HOLD ALL BAND DATA </span>
<span class="comments">; FOR EACH SENSOR AND WAVELENGTH VALUES</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: DEFINING ARRAYS TO HOLD RSR DATA'
  RSR_ARRAY     = FLTARR(500,MAX(SENSOR_BANDS),NUM_SENSORS)
  RSR_WL        = RSR_ARRAY
  RSR_DATA      = FLTARR(N_WL,MAX(SENSOR_BANDS),NUM_SENSORS)
  RSR_TEMPLATE  = GET_DIMITRI_RSR_TEMPLATE()

<span class="comments">;------------------------------------</span>
<span class="comments">; LOOP OVER EACH SENSOR AND READ RSR DATA</span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: STARTING LOOP TO READ EACH SENSORS DATA'  
  FOR RSR_SENS = 0,NUM_SENSORS-1 DO BEGIN
    FOR RSR_BD = 0,SENSOR_BANDS[RSR_SENS]-1 DO BEGIN
      RES = FILE_SEARCH(SR_FOLDER+SENSOR_ID[RSR_SENS]+DL+'RSR_'+SENSOR_ID[RSR_SENS]+'_BAND_'+STRTRIM(STRING(RSR_BD),2)+'.txt')
      IF STRCMP(RES[0],'') NE 1 THEN BEGIN
        TEMP = READ_ASCII(RES[0],TEMPLATE = RSR_TEMPLATE)
        RSR_ARRAY[0:N_ELEMENTS(TEMP.(0))-1,RSR_BD,RSR_SENS] = TEMP.(1)
        RSR_WL[0:N_ELEMENTS(TEMP.(0))-1,RSR_BD,RSR_SENS]    = TEMP.(0)
      ENDIF
    ENDFOR
  ENDFOR

<span class="comments">;------------------------------------</span>
<span class="comments">; LOOP OVER WAVELENGTH AND FIND DATA </span>
<span class="comments">; FOR EACH SENSOR AND EACH BAND</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: LOOPING OVER EACH WAVELENGTH TO FIND RSR DATA'
  FOR RSR_WV=0,N_WL-1 DO BEGIN
  TWL = WAVELENGTHS[RSR_WV]
    FOR RSR_SENS=0,NUM_SENSORS-1 DO BEGIN
      FOR RSR_BD=0,SENSOR_BANDS[RSR_SENS]-1 DO BEGIN
        TMIN = MIN(ABS(RSR_WL[*,RSR_BD,RSR_SENS]-TWL))
       IF TMIN LT 1.6 THEN BEGIN
          RES = WHERE(ABS(RSR_WL[*,RSR_BD,RSR_SENS]-TWL) EQ TMIN)
          IF RES[0] GT -1 THEN BEGIN
            RSR_DATA[RSR_WV,RSR_BD,RSR_SENS] = RSR_ARRAY[RES[0],RSR_BD,RSR_SENS]
          ENDIF
        ENDIF
      ENDFOR
    ENDFOR
  ENDFOR
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: END OF DATA RETRIEVAL LOOPS'

<span class="comments">;------------------------------------</span>
<span class="comments">; RELEASE MEMORY FROM ARRAYS</span>
  
  RSR_ARRAY = 0
  RSR_WL    = 0

<span class="comments">;------------------------------------</span>
<span class="comments">; CREATE AN ARRAY OF OBJECTS TO HOLD </span>
<span class="comments">; THE OBJECT PLOTS AND MODELS FOR EACH </span>
<span class="comments">; BAND OF EACH SENSOR</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: CREATING OBJECT ARRAY FOR ALL SENSORS'
  RSR_OBJ  = OBJARR(MAX(SENSOR_BANDS),NUM_SENSORS,2) 
  USR_DATA = OBJARR(2)
  SENS_ON  = INTARR(NUM_SENSORS)

<span class="comments">;------------------------------------ </span>
<span class="comments">; SET THE PLOT COLOURS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: RETRIEVEING PLOT COLOURS'
  SENSOR_COLOURS  = DIMITRI_RSR_COLOURS()
  USER_COLOUR     = [!COLOR.ORANGE]

<span class="comments">;------------------------------------ </span>
<span class="comments">; SET THE PLOT PARAMETERS  </span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: SETTING PLOT PARAMETERS'
  RSR_XRANGE  = [RANGE[0],RANGE[1]]
  RSR_YRANGE  = [0.0,1.]
  XMAJTICKS   = (1+(RANGE[1]-RANGE[0])*0.05)&lt<span class="comments">;11</span>
  YMAJTICKS   = RSR_YRANGE[1]-RSR_YRANGE[0]

<span class="comments">;------------------------------------ </span>
<span class="comments">; CREATE THE PALETTE OBJECT</span>
  
  COLORTABLE  = 39
  RSR_PALETTE = OBJ_NEW('IDLGRPALETTE')
  RSR_PALETTE->LOADCT, COLORTABLE

<span class="comments">;------------------------------------  </span>
<span class="comments">; CREATE X AND Y TITLE OBJECTS</span>

  IF STRCMP(STRUPCASE(!VERSION.OS_FAMILY),'WINDOWS') EQ 1 THEN   RSR_FONT  = OBJ_NEW('IDLGRFONT',SIZE=11.0) ELSE $
  RSR_FONT  = OBJ_NEW('IDLGRFONT',SIZE=9.0)
  RSR_YTITLE = OBJ_NEW('IDLGRTEXT',"Relative Spectral Response",RECOMPUTE_DIMENSION=1,FONT=RSR_FONT)
  RSR_XTITLE = OBJ_NEW('IDLGRTEXT',"Wavelength (nm)",RECOMPUTE_DIMENSION=1,FONT=RSR_FONT)

<span class="comments">;------------------------------------ </span>
<span class="comments">; CREATE THE AXIS OBJECTS</span>

  RSR_XAXIS = OBJ_NEW('IDLGRAXIS', 0, TICKLEN=0.025, MAJOR=XMAJTICKS, TITLE=RSR_XTITLE, $
                      RANGE=RSR_XRANGE, /EXACT, XCOORD_CONV=NORM_COORD(RSR_XRANGE))
  RSR_YAXIS = OBJ_NEW('IDLGRAXIS', 1, TICKLEN=0.025, MINOR=4, TITLE=RSR_YTITLE, $
                      RANGE=RSR_YRANGE, /EXACT, YCOORD_CONV=NORM_COORD(RSR_YRANGE))
  RSR_XAXIS->GETPROPERTY,TICKTEXT=TEMP_TEXTx
  TEMP_TEXTx->SETPROPERTY,FONT=RSR_FONT
  RSR_yAXIS->GETPROPERTY,TICKTEXT=TEMP_TEXTy
  TEMP_TEXTy->SETPROPERTY,FONT=RSR_FONT
 
 
  RSR_LEGEND = OBJ_NEW('IDLGRLEGEND',/SHOW_OUTLINE,/HIDE,BORDER_GAP=0.2,FONT=RSR_FONT)
 
 <span class="comments">;------------------------------------  </span>
 <span class="comments">; CREATE THE PLOT MODEL</span>
 
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: CREATING THE PLOT AND LEGEND MODELS'
  RSR_MODEL = OBJ_NEW('IDLGRMODEL')
  RSR_MODEL->ADD,RSR_XAXIS
  RSR_MODEL->ADD,RSR_YAXIS
  RSR_LEGENDMODEL = OBJ_NEW('IDLGRMODEL')
  RSR_LEGENDMODEL->ADD,RSR_LEGEND

<span class="comments">;------------------------------------ </span>
<span class="comments">; CREATE THE PLOT VIEW</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: CREATING THE RSR_VIEW'
  RSR_VIEW = OBJ_NEW('IDLGRVIEW',/DOUBLE)
  RSR_VIEW->ADD,RSR_MODEL
  RSR_VIEW->ADD,RSR_LEGENDMODEL
  <span class="comments">;RSR_VIEW->SETPROPERTY, VIEWPLANE_RECT = [-0.1, -0.1, 1.2, 1.2]</span>
  RSR_VIEW->SETPROPERTY, VIEWPLANE_RECT = [-0.14, -0.12, 1.3, 1.2]

<span class="comments">;------------------------------------ </span>
<span class="comments">; GET THE SCREEN DIMENSIONS</span>

  DIMS  = GET_SCREEN_SIZE()
  XSIZE = 700
  YSIZE = 450
  XLOC  = (DIMS[0]/2)-(XSIZE/2)
  YLOC  = (DIMS[1]/2)-(YSIZE/2)

<span class="comments">;------------------------------------ </span>
<span class="comments">; DEFINE THE BASE WIDGET FOR THE PLOT</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: DEFINING THE WIDGET AND BUTTONS'
  RSR_WD_TLB  = WIDGET_BASE(TITLE='DIMITRI: RELATIVE SPECTRAL RESPONSE',MBAR=MENUBASE,TLB_SIZE_EVENTS=1,$
                            COLUMN=1, BASE_ALIGN_CENTER=1,XOFFSET=XLOC, YOFFSET=YLOC)
  RSR_WD_DRAW = WIDGET_DRAW(RSR_WD_TLB, XSIZE=XSIZE, YSIZE=YSIZE, GRAPHICS_LEVEL=2, RETAIN=2)

<span class="comments">;------------------------------------ </span>
<span class="comments">; CREATE THE FILE MENU AND BUTTONS</span>

  RSR_WD_DLIM = WIDGET_BUTTON(MENUBASE,     VALUE='||', SENSITIVE=0)
  RSR_WD_FILE = WIDGET_BUTTON(MENUBASE,     VALUE='File'      ,/MENU)
  RSR_WD_DLIM = WIDGET_BUTTON(MENUBASE,     VALUE='||', SENSITIVE=0)
  RSR_WD_OPTS = WIDGET_BUTTON(MENUBASE,     VALUE='Options'   ,/MENU)
  RSR_WD_DLIM = WIDGET_BUTTON(MENUBASE,     VALUE='||', SENSITIVE=0)
  RSR_WD_IMPT = WIDGET_BUTTON(RSR_WD_FILE,  VALUE='Import'    ,UVALUE='IMPORT',EVENT_PRO='RSR_OBJECT_IMPORT')
  RSR_WD_EXPT = WIDGET_BUTTON(RSR_WD_FILE,  VALUE='Save as...',/MENU)
  RSR_WD_OUPT = WIDGET_BUTTON(RSR_WD_EXPT,  VALUE='JPG'       ,UVALUE='JPG'   ,EVENT_PRO='RSR_OBJECT_EXPORT')
  RSR_WD_OUPT = WIDGET_BUTTON(RSR_WD_EXPT,  VALUE='PNG'       ,UVALUE='PNG'   ,EVENT_PRO='RSR_OBJECT_EXPORT')
  RSR_WD_OUPT = WIDGET_BUTTON(RSR_WD_EXPT,  VALUE='CSV'       ,UVALUE='CSV'   ,EVENT_PRO='RSR_OBJECT_EXPORT')
  RSR_WD_EXIT = WIDGET_BUTTON(RSR_WD_FILE, /SEPARATOR         ,VALUE ='Exit'  ,EVENT_PRO='RSR_OBJECT_EXIT')

<span class="comments">;------------------------------------ </span>
<span class="comments">; CREATE THE OVERLAY MENU AND BUTTONS</span>

  RSR_WD_OVLY = WIDGET_BUTTON(MENUBASE,     VALUE='Overlay' ,/MENU)
<span class="comments">;  RSR_WD_OPTS = WIDGET_BUTTON(RSR_WD_OVLY,  VALUE='Options' ,/MENU)</span>
  RSR_WD_REFS = WIDGET_BUTTON(RSR_WD_OPTS,  VALUE='Legend'  ,UVALUE='LEGEND', EVENT_PRO='RSR_OBJECT_OPTION')
  RSR_WD_REFS = WIDGET_BUTTON(RSR_WD_OPTS,  VALUE='Reset'   ,UVALUE='RESET' , EVENT_PRO='RSR_OBJECT_OPTION')

<span class="comments">;------------------------------------ </span>
<span class="comments">; LOOP OVER EACH SENSOR AND CREATE BUTTON</span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: STARTING LOOP TO DEFINE BUTTONS FOR EACH SENSOR'
  FOR RSR_SENS=0,NUM_SENSORS-1 DO BEGIN
    RSR_WD_SENS = WIDGET_BUTTON(RSR_WD_OVLY, VALUE=SENSOR_ID[RSR_SENS],$
                                UVALUE=SENSOR_ID[RSR_SENS], EVENT_PRO='RSR_OBJECT_OPTION')
  ENDFOR

<span class="comments">;------------------------------------  </span>
<span class="comments">; REALIZE THE WIDGET</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: REALISING THE WIDGET'
  WIDGET_CONTROL, RSR_WD_TLB, /REALIZE
  WIDGET_CONTROL, RSR_WD_DRAW, GET_VALUE=RSR_WINDOW
 
<span class="comments">;------------------------------------  </span>
<span class="comments">; CREATE THE BLANK PLOT AND MOVE THE LEGEND</span>
 
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: ADDING THE BLANK PLOT AND MOVING THE LEGEND'
  RSR_WINDOW->DRAW, RSR_VIEW
  DIMS = RSR_LEGEND->COMPUTEDIMENSIONS(RSR_WINDOW) 
  RSR_LEGENDMODEL->TRANSLATE, 1.0, .8, 0 
  RSR_WINDOW->SETPROPERTY, PALETTE=RSR_PALETTE
  RSR_WINDOW->DRAW, RSR_VIEW

<span class="comments">;------------------------------------  </span>
<span class="comments">; DEFINE THE INFO STRUCTURE TO CONTAIN </span>
<span class="comments">; ALL DATA AND OBJECTS</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RSR PLOT MODULE: DEFINING SUPER STRUCTURE TO CONTAIN ALL DATA'
  RSR_INFO = {RSR_PALETTE:RSR_PALETTE, $
              RSR_WINDOW:RSR_WINDOW, $
              RSR_VIEW:RSR_VIEW, $
              RSR_LEGEND:RSR_LEGEND, $
              RSR_LEGENDMODEL:RSR_LEGENDMODEL,$
              RSR_XRANGE:RSR_XRANGE,$
              RSR_YRANGE:RSR_YRANGE,$
              RSR_YTITLE:RSR_YTITLE,$
              RSR_XTITLE:RSR_XTITLE,$
              RSR_XAXIS:RSR_XAXIS,$
              RSR_YAXIS:RSR_YAXIS,$
              RSR_DATA:RSR_DATA,$
              RSR_OBJ:RSR_OBJ,$
              WAVELENGTHS:WAVELENGTHS, $
              SENSOR_COLOURS:SENSOR_COLOURS,$
              SENSOR_ID:SENSOR_ID, $
              SENSOR_BANDS:SENSOR_BANDS, $
              SENS_ON:SENS_ON, $
              USR_DATA:USR_DATA,$
              USER_DATA_ON:[0],$
              USER_COLOUR:USER_COLOUR,$
              USER_DATA_NAME:'', $
              USERXDATA:PTR_NEW(0.0),$
              USERYDATA:PTR_NEW(0.0)$
             }

  IF KEYWORD_SET(GROUP_LEADER) THEN WIDGET_CONTROL,RSR_WD_TLB,SET_UVALUE=RSR_INFO,/NO_COPY,GROUP_LEADER=GROUP_LEADER $
  ELSE WIDGET_CONTROL,RSR_WD_TLB,SET_UVALUE=RSR_INFO,/NO_COPY
  XMANAGER,'RSR_OBJECT', RSR_WD_TLB, GROUP_LEADER=GROUP,/NO_BLOCK

END
</code>
    </div>
  </body>
</html>