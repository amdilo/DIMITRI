<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Tue Jul  2 12:51:05 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>recalibrate_doublets_old.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="recalibrate_doublets_old.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;*</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      RECALIBRATE_DOUBLETS       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      RECALIBRATES EXTRACTED DOUBLET DATA USING THE COMPUTED INTERCALIBRATION COEFICIENTS.</span>
<span class="comments">;*      THE ROUTINE AUTOMATICALLY RECALIBRATES ALL AVAILABLE BAND DATA WITHIN THE CAL_SENSOR.</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = RECALIBRATE_DOUBLETS(OUTPUT_FOLDER,RC_REGION,REF_SENSOR,REF_PROC_VER,$</span>
<span class="comments">;*                                 CAL_SENSOR,CAL_PROC_VER)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      OUTPUT_FOLDER   - THE FULL PATH OF THE OUTPUT FOLDER  </span>
<span class="comments">;*      RC_REGION       - THE VALIDATION SITE NAME E.G. 'Uyuni'</span>
<span class="comments">;*      REF_SENSOR      - THE NAME OF THE REFERENCE SENSOR FOR INTERCALIBRATION</span>
<span class="comments">;*      REF_PROC_VER    - THE PROCESSING VERISON OF THE REFERENCE SENSOR</span>
<span class="comments">;*      CAL_SENSOR      - THE NAME OF THE 2ND SENSOR FOR INTERCALIBRATION</span>
<span class="comments">;*      CAL_PROC_VER    - THE PROCESSING VERISON OF THE 2ND SENSOR</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      VERBOSE         - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      STATUS          - 1: NO ERRORS REPORTED, (-1) OR 0: ERRORS DURING INGESTION </span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*                    - M BOUVET  - PROTOTYPE DIMITRI VERSION</span>
<span class="comments">;*        21 JAN 2011 - C KENT    - DIMITRI-2 V1.0</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*        21 JAN 2011 - C KENT    - </span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION RECALIBRATE_DOUBLETS,OUTPUT_FOLDER,RC_REGION,REF_SENSOR,REF_PROC_VER,$
                              CAL_SENSOR,CAL_PROC_VER,VERBOSE=VERBOSE

<span class="comments">;----------------------------------------- </span>
<span class="comments">; CHECK INPUT SENSORS AND PROC_VERSIONS </span>

  IF STRCMP(REF_SENSOR,CAL_SENSOR) EQ 1 AND $
     STRCMP(REF_PROC_VER,CAL_PROC_VER) EQ 1 THEN BEGIN
    PRINT, 'RECALIBRATE_DATA: ERROR, TRYING TO COMPARE THE SAME DATA'
    RETURN,0     
  ENDIF
  
<span class="comments">;-----------------------------------------</span>
<span class="comments">; CHECK OFOLDER EXISTS AND IS CORRECT FORMAT</span>
  
  RES = FILE_INFO(OUTPUT_FOLDER)
  IF RES.EXISTS EQ 0 THEN BEGIN
    PRINT,"RECALIBRATE_DATA: OUTPUT FOLDER DOESN'T EXIST"
    RETURN,-1
  ENDIF
  
  RES = STRSPLIT(OUTPUT_FOLDER,'\',/EXTRACT)
  IF N_ELEMENTS(RES) EQ 1 THEN DL = '/' ELSE DL = '\' 

<span class="comments">;-----------------------------------------</span>
<span class="comments">; GET THE CURRENT LOCATION</span>

  CD, CURRENT=RC_CDIR
  RES = STRPOS(RC_CDIR,'DIMITRI_',/REVERSE_SEARCH)
  IF RES EQ -1 THEN BEGIN
    PRINT, 'RECALIBRATE_DATA: ERROR, CANNOT DETERMINE DIMITRI LOCATION, RETURNING'
    RETURN,-1
  ENDIF

<span class="comments">;-----------------------------------------</span>
<span class="comments">; DEFINE INPUT/OUTPUT FILES</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RECALIBRATE_DATA: DEFINING INPUT/OUTPUT FILES'
  MAIN_DIRC     = STRMID(RC_CDIR,0,RES+11)+DL 
  ED_FOLDER     = STRING(OUTPUT_FOLDER+DL+'DOUBLET_EXTRACTION'+DL)
  IC_FOLDER     = STRING(OUTPUT_FOLDER+DL+'INTERCALIBRATION'+DL)
  RC_FOLDER     = STRING(OUTPUT_FOLDER+DL+'RECALIBRATION'+DL)
  REF_IFILE     = STRING(MAIN_DIRC+'Input'+DL+'Site_'+RC_REGION+DL+REF_SENSOR+DL+'Proc_'+REF_PROC_VER+DL+REF_SENSOR+'_TOA_REF.dat')
  TMP_IFILE     = STRING(IC_FOLDER+       'ICOEF_'+    RC_REGION+'_'+CAL_SENSOR+'_'+CAL_PROC_VER+'_REF_'+REF_SENSOR+'_'+REF_PROC_VER+'_')
  CSV_FILE      = STRING(OUTPUT_FOLDER+DL+'RCAL_' +    RC_REGION+'_'+CAL_SENSOR+'_'+CAL_PROC_VER+'_REF_'+REF_SENSOR+'_'+REF_PROC_VER+'.csv')  
  ED_REFS_CALS  = STRING(ED_FOLDER+       'ED_'+       RC_REGION+'_'+REF_SENSOR+'_'+REF_PROC_VER+'_'+    CAL_SENSOR+'_'+CAL_PROC_VER+'.dat')
  ED_CALS_REFS  = STRING(ED_FOLDER+       'ED_'+       RC_REGION+'_'+CAL_SENSOR+'_'+CAL_PROC_VER+'_'+    REF_SENSOR+'_'+REF_PROC_VER+'.dat')
  OFILE_CAL     = STRING(RC_FOLDER+       'RECAL_'+    RC_REGION+'_'+CAL_SENSOR+'_'+CAL_PROC_VER+'_REF_'+REF_SENSOR+'_'+REF_PROC_VER+'.dat')
  OFILE_REF     = STRING(RC_FOLDER+       'RECAL_REF_'+RC_REGION+'_'+REF_SENSOR+'_'+REF_PROC_VER+'.dat')
  
<span class="comments">;-----------------------------------------</span>
<span class="comments">; CREATE RECALIBRATION FOLDER IF IT </span>
<span class="comments">; DOESN'T EXIST</span>

  RES = FILE_INFO(RC_FOLDER)
  IF RES.EXISTS NE 1 OR RES.DIRECTORY NE 1 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN PRINT,"RECALIBRATE_DATA: RECALIBRATION FOLDER DOESN'T EXIST, CREATING"
    FILE_MKDIR,RC_FOLDER 
  ENDIF
  
<span class="comments">;-----------------------------------------</span>
<span class="comments">; DEFINE SENSOR AND PROC_VERSION ARRAYS</span>

  SENS = [REF_SENSOR,CAL_SENSOR,CAL_SENSOR]
  PVER = [REF_PROC_VER,CAL_PROC_VER,CAL_PROC_VER]  

<span class="comments">;-----------------------------------------    </span>
<span class="comments">; RESTORE AND STORE DOUBLET EXTRACTIONS </span>
<span class="comments">; SENSORS IN NEW ARRAYS (SETTING ALL </span>
<span class="comments">; CAL_REFLECTANCES TO 0.0)</span>
  
  RES = FILE_INFO(ED_REFS_CALS)
  RES2 = FILE_INFO(ED_CALS_REFS)  
  IF RES.EXISTS   EQ 0 OR $
     RES2.EXISTS  EQ 0 THEN BEGIN
    PRINT,"RECALIBRATE_DATA: DOUBLET EXTRACTION DATA NOT FOUND"
    RETURN,0
  ENDIF  

  NUM_NON_REF = 5
  RESTORE,ED_REFS_CALS
  RESTORE,ED_CALS_REFS 
  CAL_DATA = ED_SENSOR2_SENSOR1
  CAL_DATA[NUM_NON_REF:N_ELEMENTS(CAL_DATA[*,0])-2,*] = 0.0

<span class="comments">;----------------------------------------- </span>
<span class="comments">; GET NUMBER OF BANDS WITHIN CAL_SENSOR </span>
<span class="comments">; AND REF_SENSOR</span>

  SIZE_CAL    = SIZE(CAL_DATA)
  SIZE_REF    = SIZE(ED_SENSOR1_SENSOR2)
  NBANDS_CAL  = (SIZE_CAL[1]-1-NUM_NON_REF)
  NBANDS_REF  = (SIZE_REF[1]-1-NUM_NON_REF)
  CAL_COUNTER = 0

<span class="comments">;-----------------------------------------</span>
<span class="comments">; LOOP OVER EACH CAL_SENSOR BAND AND </span>
<span class="comments">; RECALIBRATE IF COEFICIENTS COMPUTED</span>
 
  FOR RC_BAND=0,NBANDS_CAL-1 DO BEGIN

<span class="comments">;-----------------------------------------  </span>
<span class="comments">; GET DIMITRI WAVELENGTH STRING AND </span>
<span class="comments">; FIND CALIBRATION COEFICIENTS</span>

    TEMP = CONVERT_INDEX_TO_WAVELENGTH(RC_BAND,CAL_SENSOR,/VERBOSE)
    TEMP = STRING(TMP_IFILE+TEMP+'.dat')
    RES  = FILE_INFO(TEMP)
    IF RES.EXISTS EQ 0 THEN BEGIN
      PRINT, 'RECALIBRATE_DATA: NO CALIBRATION COEFICIENTS FOUND, GOING TO NEXT BAND'
      GOTO,NEXT_BAND
    ENDIF

<span class="comments">;----------------------------------------- </span>
<span class="comments">; RESTORE CALIBRAITON COEFICIENTS AND APPLY</span>

    RESTORE,TEMP
    BIAS                              = POLY_COEFS[0]+ED_SENSOR2_SENSOR1[0,*]*POLY_COEFS[1]+ $
                                        (ED_SENSOR2_SENSOR1[0,*])^2*POLY_COEFS[2]
    CAL_DATA[NUM_NON_REF+RC_BAND,*]  = ED_SENSOR2_SENSOR1[NUM_NON_REF+RC_BAND, *]*(1.0-BIAS/100.0)
    CAL_COUNTER++
    NEXT_BAND:
  ENDFOR
  
  IF CAL_COUNTER EQ 0 THEN BEGIN
    PRINT, 'RECALIBRATE_DATA: ERROR, NO INTERCAL COEFICIENTS FOUND'
    RETURN,0
  ENDIF

<span class="comments">;---------------------------------------- </span>
<span class="comments">;RESTORE REF DATA AND SAVE THE REFLECTANCE DATA AS SAV FILES</span>

  RESTORE,REF_IFILE
  <span class="comments">;SAVE,CAL_DATA,          FILENAME=OFILE_CAL</span>
  <span class="comments">;SAVE,SENSOR_L1B_REF,    FILENAME=OFILE_REF</span>
  SAVE,ED_SENSOR1_SENSOR2,    FILENAME=OFILE_REF
<span class="comments">;---------------------------------------- </span>
<span class="comments">; CREATE AN OUTPUT CSV FILE CONTAINING ALL DATA </span>
  
  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RECALIBRATE_DATA: SAVING DATA AS A CSV FILE'
  NTIME = N_ELEMENTS(ED_SENSOR1_SENSOR2[0,*])
  HEADER = ['REGION','SENSOR','PROCESSING_VERSION','PARAMETER']
  TMP_HD = ['TIME','VZA','VAA','SZA','SAA']
  FORMAT = STRING('(4(A,1H;),'+STRTRIM(STRING(NTIME-1),2)+'(F15.6,1H;),(F15.6))')
  OPENW,OUTF,CSV_FILE,/GET_LUN
  PRINTF,OUTF,FORMAT=FORMAT,HEADER,ED_SENSOR1_SENSOR2[0,*]

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RECALIBRATE_DATA: STARTING LOOP TO OUTPUT SENSOR DATA TO CSV'  
  FOR RCS=0,2 DO BEGIN
    
    CASE RCS OF
    0:BEGIN
        DATA = ED_SENSOR1_SENSOR2  
        TMP_BANDS = NBANDS_REF
      END
    1:BEGIN
        DATA = ED_SENSOR2_SENSOR1  
        TMP_BANDS = NBANDS_CAL
      END
    2:BEGIN
        DATA = CAL_DATA
        TMP_BANDS = NBANDS_CAL
      END
    ENDCASE
      
    COUNTER = 0
    FOR RCB=1,TMP_BANDS+NUM_NON_REF-1 DO BEGIN
      IF RCB LE 4 THEN BEGIN
        IF RCS EQ 2 THEN PRINTF,OUTF,FORMAT=FORMAT,RC_REGION,SENS[RCS],PVER[RCS],STRING('RECAL_'+TMP_HD[RCB]),DATA[RCB,*] $
        ELSE PRINTF,OUTF,FORMAT=FORMAT,RC_REGION,SENS[RCS],PVER[RCS],TMP_HD[RCB],DATA[RCB,*]
      ENDIF ELSE BEGIN
        IF RCS EQ 2 THEN PRINTF,OUTF,FORMAT=FORMAT,RC_REGION,SENS[RCS],PVER[RCS],'RECAL_TOA_BAND_'+STRTRIM(STRING(COUNTER),2),DATA[NUM_NON_REF+COUNTER,*] $
        ELSE PRINTF,OUTF,FORMAT=FORMAT,RC_REGION,SENS[RCS],PVER[RCS],'TOA_BAND_'+STRTRIM(STRING(COUNTER),2),DATA[NUM_NON_REF+COUNTER,*]
        COUNTER++   
      ENDELSE
    ENDFOR
  ENDFOR

  IF KEYWORD_SET(VERBOSE) THEN PRINT,'RECALIBRATE_DATA: SUCCESSFULLY RECALIBRATED DATA'  
  FREE_LUN,OUTF
  RETURN,1

END
</code>
    </div>
  </body>
</html>