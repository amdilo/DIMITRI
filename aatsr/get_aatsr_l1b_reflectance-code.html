<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<!-- Generated by IDLdoc 3.5.1 on Thu Jul  4 16:01:28 2013 -->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>get_aatsr_l1b_reflectance.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)</title>

    
    <link rel="stylesheet" type="text/css" media="all"
          href="../idldoc-resources/main.css" />
    <link rel="stylesheet" type="text/css" media="print"
          href="../idldoc-resources/main-print.css" />
    

    <script type="text/javascript">
      function setTitle() {
        parent.document.title="get_aatsr_l1b_reflectance.pro (Documentation for /home/marrabld/projects/DIMITRI_2.0/Source/)";
      }
    </script>
  </head>

  <body onload="setTitle();" id="root">
    <div class="content">
      <code class="source"><span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;+</span>
<span class="comments">;* NAME:</span>
<span class="comments">;*      GET_AATSR_L1B_RADIANCE       </span>
<span class="comments">;* </span>
<span class="comments">;* PURPOSE:</span>
<span class="comments">;*      RETURNS THE L1B RADIANCE FOR A SPECIFIC AATSR BAND AND DIRECTION</span>
<span class="comments">;* </span>
<span class="comments">;* CALLING SEQUENCE:</span>
<span class="comments">;*      RES = GET_AATSR_L1B_REFLECTANCE(FILENAME,IN_BAND,L1B_DIR)      </span>
<span class="comments">;* </span>
<span class="comments">;* INPUTS:</span>
<span class="comments">;*      FILENAME - A SCALAR CONTAINING THE FILENAME OF THE PRODUCT FOR RADIANCE EXTRACTION </span>
<span class="comments">;*      IN_BAND  - THE INDEX OF RADIANCE BAND TO BE RETURNED, STARTS FROM 0   </span>
<span class="comments">;*      L1B_DIR  - A STRING OF THE DIRECTION REQUIRED, EITHER 'NADIR' OR 'FWARD'</span>
<span class="comments">;*</span>
<span class="comments">;* KEYWORDS:</span>
<span class="comments">;*      ENDIAN_SIZE - MACHINE ENDIAN SIZE (0: LITTLE, 1: BIG)</span>
<span class="comments">;*      VERBOSE     - PROCESSING STATUS OUTPUTS</span>
<span class="comments">;*</span>
<span class="comments">;* OUTPUTS:</span>
<span class="comments">;*      L1B_REF     - TOA REFLECTANCE FOR IN_BAND. NOTE, THE REFLECTANCE AT POINT [0,0] </span>
<span class="comments">;*                    IS EQUAL TO THE TOP RIGHT PIXEL IN BEAM.  </span>
<span class="comments">;*</span>
<span class="comments">;* COMMON BLOCKS:</span>
<span class="comments">;*      NONE</span>
<span class="comments">;*</span>
<span class="comments">;* MODIFICATION HISTORY:</span>
<span class="comments">;*      17 NOV 2005 - M BOUVET - PROTOTYPE DIMITRI VERSION</span>
<span class="comments">;*      10 DEC 2010 - C KENT   - DIMITRI-2 V1.0</span>
<span class="comments">;*      14 DEC 2010 - C KENT   - MINOR TIDYING OF CODE, REMOVAL OF OLD COMMENTS</span>
<span class="comments">;*</span>
<span class="comments">;* VALIDATION HISTORY:</span>
<span class="comments">;*      12 DEC 2010 - C KENT    - WINDOWS 32-BIT MACHINE IDL 7.1: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                                BAND REFLECTANCE EQUAL TO BEAM VISAT FOR AATSR L1B DATA</span>
<span class="comments">;*      06 JAN 2010 - C KENT    - LINUX 64-BIT MACHINE IDL 8.0: COMPILATION SUCCESSFUL,</span>
<span class="comments">;*                                VALUES EQUAL TO WINDOWS 32-BIT MACHINE</span>
<span class="comments">;*</span>
<span class="comments">;**************************************************************************************</span>
<span class="comments">;**************************************************************************************</span>

FUNCTION GET_AATSR_L1B_REFLECTANCE,FILENAME,IN_BAND,L1B_DIR,ENDIAN_SIZE=ENDIAN_SIZE,VERBOSE=VERBOSE

<span class="comments">;------------------------------------------------</span>
<span class="comments">; CHECK FILENAME DIRECTION AND IN_BAND ARE NOMINAL</span>

  IF FILENAME EQ '' THEN BEGIN
    PRINT, 'AATSR L1B REFLECTANCE: ERROR, INPUT FILENAME INCORRECT'
    RETURN,-1
  ENDIF
 
  IF N_ELEMENTS(IN_BAND) NE 1 OR $
      IN_BAND[0] LT 0 OR $
      IN_BAND[0] GT 6 THEN BEGIN
    PRINT, 'AATSR L1B REFLECTANCE: ERROR, INPUT IN_BAND INCORRECT'
    RETURN,-1
  ENDIF 
   
<span class="comments">;------------------------------------------------</span>
<span class="comments">; IF ENDIAN SIZE NOT PROVIDED THEN GET VALUE</span>

  IF N_ELEMENTS(ENDIAN_SIZE) EQ 0 THEN BEGIN
    IF KEYWORD_SET(VERBOSE) THEN BEGIN
      PRINT, 'AATSR L1B REFLECTANCE: NO ENDIAN SIZE PROVIDED, RETRIEVING...'
      ENDIAN_SIZE = GET_ENDIAN_SIZE(/VERBOSE)
    ENDIF ELSE ENDIAN_SIZE = GET_ENDIAN_SIZE()
  ENDIF

<span class="comments">;------------------------------------------------</span>
<span class="comments">;DEFINE HEADER VARIABLES</span>

  MPH_SIZE = 1247
  SPH_SIZE = 12830
  FILE_MPH = BYTARR(MPH_SIZE)
  FILE_SPH = BYTARR(SPH_SIZE)
  
<span class="comments">;-----------------------------------------------</span>
<span class="comments">; CONVERT IN_BAND NUMBER TO STRING AND DEFINE BAND NAMES</span>

  IN_BAND_NAME=['00545_00565','00649_00669','00855_00875','01580_01640','03505_03895','10400_11300','11500_12500']
  
<span class="comments">;-----------------------------------------------</span>
<span class="comments">; OPEN THE FILE AND EXTRACT HEADER</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: OPENING PRODUCT'
  OPENR,PRD_REF,FILENAME,/GET_LUN
  READU,PRD_REF,FILE_MPH
  READU,PRD_REF,FILE_SPH

<span class="comments">;-----------------------------------------------</span>
<span class="comments">; RETRIEVE: POSITION OF DSD, DSD,OFFSET,DS_SIZE,NUMBER OF RECORDS, RECORD SIZE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: RETRIEVING DSD INFORMATION'
  REF_DSD_POS =STRPOS(FILE_SPH,'DS_NAME="'+IN_BAND_NAME[IN_BAND]+'_NM_'+L1B_DIR+'_TOA_MDS"')
  REF_DSD=STRMID(FILE_SPH, REF_DSD_POS,280)
  REF_OFFSET = STRMID(REF_DSD, strpos(REF_DSD, 'DS_OFFSET=+')+10,21)+0L
  REF_SIZE = STRMID(REF_DSD, strpos(REF_DSD, 'DS_SIZE=+')+8,21)+0L
  REF_DSR_NUMBER = STRMID(REF_DSD, strpos(REF_DSD, 'NUM_DSR=+')+8,11)+0L
  REF_DSR_SIZE = STRMID(REF_DSD, strpos(REF_DSD, 'DSR_SIZE=+')+9,11)+0L

<span class="comments">;---------------------------------------------</span>
<span class="comments">; DEFINE VARIABLE FOR HOLDING THE L1B DATA AND </span>
<span class="comments">; THE TEMPORARY VARIABLE FOR CONTAINING THE DATA </span>
<span class="comments">; WITHIN THE READING LOOP</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: DEFINING DATA ARRAYS FOR OUTPUT'
  L1B_REF     = uINTARR((REF_DSR_SIZE-20)/2,REF_DSR_NUMBER)
  L1B_REF_REC = uINTARR((REF_DSR_SIZE-20)/2)
  NODATA      = BYTARR(20)

<span class="comments">;---------------------------------------------</span>
<span class="comments">; POINT TO THE L1B RADIANCE DATA</span>

  POINT_LUN, PRD_REF, REF_OFFSET
  
<span class="comments">;---------------------------------------------</span>
<span class="comments">; LOOP OVER EACH RECORD AND EXTRACT DATA</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: STARTING LOOP FOR DATA EXTRACTION'
  FOR RREC=0,REF_DSR_NUMBER-1 DO BEGIN
    READU,PRD_REF,NODATA
    READU,PRD_REF,L1B_REF_REC

<span class="comments">;----------------------------------------</span>
<span class="comments">; SWAP ENDIAN IF NEEDED - AATSR DATA IS BIG ENDIAN</span>
  
    IF ENDIAN_SIZE EQ 0 THEN L1B_REF_REC = SWAP_ENDIAN(L1B_REF_REC)
    
    L1B_REF[*,RREC]=L1B_REF_REC
    
  ENDFOR <span class="comments">; END OF LOOP OVER REFLECTANCE RECORDS</span>


<span class="comments">;---------------------------------------</span>
<span class="comments">; CLOSE THE FILE</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: CLOSING PRODUCTS AND RELEASING THE LUN'
  CLOSE, PRD_REF
  FREE_LUN, PRD_REF

<span class="comments">;---------------------------------------</span>
<span class="comments">; APPLY THE SCALING FACTOR AND RETURN DATA - values between 0 - 100%</span>

  IF KEYWORD_SET(VERBOSE) THEN PRINT, 'AATSR L1B REFLECTANCE: APPLYING SCALING FACTOR AND RETURNING BAND RADIANCE'
  L1B_REF=L1B_REF*0.01
  IF IN_BAND LE 3 THEN TEMP = WHERE(L1B_REF LE 0.0 OR L1B_REF GT 100.0) ELSE TEMP = WHERE(L1B_REF LE 0.0 or L1B_REF GE 500.0)
  IF TEMP[0] GT -1 THEN L1B_REF[TEMP] = 0.0
 
  RETURN,L1B_REF
  
END
</code>
    </div>
  </body>
</html>